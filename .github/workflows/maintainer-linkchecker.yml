name: Maintainer-LinkChecker

on:
  schedule:
    # Run every Sunday at 03:00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      max_workers:
        description: 'Max link-checker workers (default 230)'
        required: false
        default: '230'

jobs:
  check-external-links:
    runs-on: ubuntu-latest
    env:
      SDRL_LINKCHECK_MAX_WORKERS: ${{ github.event.inputs.max_workers || '230' }}
    
    steps:
    - name: Checkout propra-inf repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Checkout sedrila repository
      uses: actions/checkout@v4
      with:
        repository: fubinf/sedrila
        path: sedrila
        # If sedrila is a private repository, configure:
        # token: ${{ secrets.SEDRILA_ACCESS_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Install all sedrila core dependencies from pyproject.toml
        pip install \
          argparse_subcommand>=1.2 \
          blessed>=1.20 \
          bottle>=0.13 \
          GitPython>=3.1 \
          Jinja2>=3.1 \
          Markdown>=3.7 \
          matplotlib>=3.9 \
          mdx_linkify>=2.1 \
          "numpy<2" \
          pandas>=2.2 \
          Pygments>=2.17 \
          python-gnupg>=0.5.5 \
          PyYAML>=6.0 \
          requests>=2.32 \
          rich>=13.7
    
    - name: Verify environment
      run: |
        python --version
        ls -la
        ls -la sedrila/py/
    
    - name: Run link checker
      run: |
        python sedrila/py/sedrila.py maintainer --check-links --batch -- /tmp/linkcheck
      continue-on-error: false
    
    - name: Publish markdown report to job summary
      if: always()
      run: |
        REPORT_PATH="/tmp/linkcheck_i/link_check_report.md"
        if [ -f "$REPORT_PATH" ]; then
          cat "$REPORT_PATH" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "Markdown report not found at $REPORT_PATH"
        fi
    
    - name: Upload link check reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: link-check-reports
        path: |
          /tmp/linkcheck_i/link_check_report.md
        retention-days: 90
    
    - name: Display report summary
      if: always()
      run: |
        echo "=== Link Check Summary ==="
        if [ -f /tmp/linkcheck_i/link_check_report.md ]; then
          echo "Markdown report available:"
          ls -la /tmp/linkcheck_i/link_check_report.md
          echo ""
          echo "Report preview:"
          head -40 /tmp/linkcheck_i/link_check_report.md
        else
          echo "No markdown report found"
        fi
