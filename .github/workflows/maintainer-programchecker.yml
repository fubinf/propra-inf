name: Maintainer-ProgramChecker

on:
  schedule:
    # Run every Sunday at 03:30 UTC (offset from linkchecker)
    - cron: '30 3 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-example-programs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout propra-inf repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Checkout sedrila repository
      uses: actions/checkout@v4
      with:
        repository: fubinf/sedrila
        path: sedrila
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install \
          "argparse_subcommand>=1.2" \
          "blessed>=1.20" \
          "bottle>=0.13" \
          "GitPython>=3.1" \
          "Jinja2>=3.1" \
          "Markdown>=3.7" \
          "matplotlib>=3.9" \
          "mdx_linkify>=2.1" \
          "numpy<2" \
          "pandas>=2.2" \
          "Pygments>=2.17" \
          "python-gnupg>=0.5.5" \
          "PyYAML>=6.0" \
          "requests>=2.32" \
          "rich>=13.7"
        
        # Install packages needed by example programs
        pip install \
          "fastapi>=0.104" \
          "pydantic>=2.0" \
          "uvicorn>=0.24" \
          "pytest>=7.4"
    
    - name: Verify environment
      run: |
        echo "=== Python Environment ==="
        python --version
        python3 --version
        which python
        which python3
        echo ""
        echo "=== Go Environment ==="
        go version
        echo ""
        echo "=== Directory Structure ==="
        ls -la
        ls -la sedrila/py/
    
    - name: Run program checks
      run: |
        python sedrila/py/sedrila.py maintainer --check-programs --batch -- /tmp/progcheck
      continue-on-error: false

    - name: Publish markdown report to job summary
      if: always()
      run: |
        REPORT_PATH="/tmp/progcheck_i/program_test_report.md"
        if [ -f "$REPORT_PATH" ]; then
          cat "$REPORT_PATH" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "Markdown report not found at $REPORT_PATH" >> "$GITHUB_STEP_SUMMARY"
        fi

    - name: Upload program check reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: program-check-reports
        path: |
          /tmp/progcheck_i/program_test_report.md
        retention-days: 90

    - name: Display report summary
      if: always()
      run: |
        echo "=== Program Check Summary ==="
        REPORT_MD="/tmp/progcheck_i/program_test_report.md"
        if [ -f "$REPORT_MD" ]; then
          echo "Markdown report available:"
          ls -la "$REPORT_MD"
          echo ""
          echo "Report preview:"
          head -40 "$REPORT_MD"
        else
          echo "No markdown report found"
        fi
