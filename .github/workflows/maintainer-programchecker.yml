name: Maintainer-ProgramChecker

on:
  schedule:
    # Run every Sunday at 03:30 UTC (offset from linkchecker)
    - cron: '30 3 * * 0'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      max_workers:
        description: 'Max program checker workers (default 4)'
        required: false
        default: '4'

jobs:
  check-example-programs:
    runs-on: ubuntu-latest
    container: debian:12
    env:
      SDRL_PROGCHECK_MAX_WORKERS: ${{ github.event.inputs.max_workers || '4' }}

    steps:
    - name: Install system dependencies for Debian 12
      run: |
        apt-get update
        apt-get install -y \
          git \
          curl \
          ca-certificates \
          jq \
          python3.11 \
          python3.11-venv
        ln -s /usr/bin/python3.11 /usr/bin/python

    - name: Checkout propra-inf repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}

    - name: Checkout sedrila repository
      uses: actions/checkout@v4
      with:
        repository: fubinf/sedrila
        path: sedrila

    - name: Create and activate Python virtual environment
      run: |
        python -m venv /tmp/sedrila_venv
        source /tmp/sedrila_venv/bin/activate
        python -m pip install --upgrade pip
        # Install sedrila dependencies from pyproject.toml
        cd sedrila && pip install -e . && cd ..

    - name: Collect metadata and dependencies
      run: |
        source /tmp/sedrila_venv/bin/activate
        python sedrila/py/sedrila.py maintainer --log ERROR --collect > /tmp/metadata.json 2>/dev/null || echo '{"taskgroups": {}}' > /tmp/metadata.json
        echo "Collected metadata:"
        cat /tmp/metadata.json

    - name: Display required taskgroups and dependencies
      run: |
        echo "=== Taskgroups and Language Requirements ==="
        jq -r '.taskgroups | to_entries[] | "\(.key): lang_commands: \(.value.lang_commands | @json)"' /tmp/metadata.json || echo "No taskgroups specified"
        echo ""
        echo "=== Task Dependencies ==="
        jq -r '.taskgroups[] | .tasks | to_entries[] | "\(.key): deps: \(.value.deps | @json)"' /tmp/metadata.json || echo "No task dependencies specified"
        echo ""

    - name: Install language runtimes and dependencies
      run: |
        set -e

        source /tmp/sedrila_venv/bin/activate

        # Phase 1: Install language runtimes per taskgroup
        echo "=== Installing Language Runtimes per Taskgroup ==="
        jq -r '.taskgroups | to_entries[] | .value.lang_commands[] | select(. != null)' /tmp/metadata.json 2>/dev/null | sort -u | while IFS= read -r cmd; do
          [ -z "$cmd" ] && continue
          echo ""
          echo "Executing: $cmd"
          $cmd
        done

        # Phase 2: Install task-specific dependencies
        echo ""
        echo "=== Installing Task-Specific Dependencies ==="
        jq -r '.taskgroups[] | .tasks | to_entries[] | .value.deps[] | select(. != null)' /tmp/metadata.json 2>/dev/null | sort -u | while IFS= read -r cmd; do
          [ -z "$cmd" ] && continue
          echo ""
          echo "Executing: $cmd"
          $cmd
        done

        echo ""
        echo "All language runtimes and dependencies installed successfully"

    - name: Verify environment
      run: |
        echo "=== Python Environment ==="
        python --version
        python3 --version
        which python
        which python3
        echo ""
        echo "=== Go Environment ==="
        go version
        echo ""
        echo "=== Directory Structure ==="
        ls -la
        ls -la sedrila/py/
    
    - name: Run program checks
      run: |
        source /tmp/sedrila_venv/bin/activate
        python sedrila/py/sedrila.py maintainer --check-programs --batch -- /tmp/progcheck
      continue-on-error: false

    - name: Publish markdown report to job summary
      if: always()
      run: |
        REPORT_PATH="/tmp/progcheck_i/program_test_report.md"
        if [ -f "$REPORT_PATH" ]; then
          cat "$REPORT_PATH" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "Markdown report not found at $REPORT_PATH" >> "$GITHUB_STEP_SUMMARY"
        fi

    - name: Upload program check reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: program-check-reports
        path: |
          /tmp/progcheck_i/program_test_report.md
        retention-days: 90

    - name: Display report summary
      if: always()
      run: |
        echo "=== Program Check Summary ==="
        REPORT_MD="/tmp/progcheck_i/program_test_report.md"
        if [ -f "$REPORT_MD" ]; then
          echo "Markdown report available:"
          ls -la "$REPORT_MD"
          echo ""
          echo "Report preview:"
          head -40 "$REPORT_MD"
        else
          echo "No markdown report found"
        fi
